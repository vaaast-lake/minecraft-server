name: Minecraft Server Deploy

on:
  push:
    branches:
      - main
    paths:
      - 'scripts/**'
      - 'docker/**'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'ê°•ì œ ë°°í¬ (ë³€ê²½ì‚¬í•­ ë¬´ì‹œ)'
        required: false
        type: boolean
        default: false
      sync_all_files:
        description: 'ëª¨ë“  íŒŒì¼ ë™ê¸°í™” (docker + scripts)'
        required: false
        type: boolean
        default: false
      deploy_strategy:
        description: 'ìˆ˜ë™ ë°°í¬ ì „ëµ ì„ íƒ (sync_all_files í™œì„±í™” ì‹œ ë¬´ì‹œë¨)'
        required: false
        type: choice
        default: 'auto'
        options:
          - 'auto'
          - 'docker-recreate'
          - 'scripts-only'

env:
  MINECRAFT_HOME: /home/minecraft

jobs:
  deploy:
    name: Deploy Minecraft Server
    runs-on: self-hosted
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Setup Environment
        run: |
          mkdir -p $MINECRAFT_HOME/deploy-logs
          chmod 750 scripts/*.sh
      
      - name: Analyze Changes
        id: changes
        run: |
          # ëª¨ë“  íŒŒì¼ ë™ê¸°í™” ìš”ì²­ í™•ì¸
          if [ "${{ inputs.sync_all_files }}" = "true" ]; then
            echo "ğŸ”„ ëª¨ë“  íŒŒì¼ ë™ê¸°í™” ëª¨ë“œ: Docker + Scripts ì „ì²´ ë™ê¸°í™”"
            DEPLOY_STRATEGY="sync-all"
            echo "ë°°í¬ ì „ëµ: ëª¨ë“  íŒŒì¼ ë™ê¸°í™”"
            echo "deploy_strategy=$DEPLOY_STRATEGY" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "force_deploy=false" >> $GITHUB_OUTPUT
            echo "sync_all_files=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # ê°•ì œ ë°°í¬ í™•ì¸
          if [ "${{ inputs.force_deploy }}" = "true" ]; then
            echo "ğŸš¨ ê°•ì œ ë°°í¬ ëª¨ë“œ: ë³€ê²½ì‚¬í•­ ë¶„ì„ì„ ê±´ë„ˆëœë‹ˆë‹¤."
            # ìˆ˜ë™ ì „ëµì´ ì§€ì •ëœ ê²½ìš° ì‚¬ìš©, ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ê°’
            MANUAL_STRATEGY="${{ inputs.deploy_strategy }}"
            if [ -n "$MANUAL_STRATEGY" ] && [ "$MANUAL_STRATEGY" != "auto" ]; then
              DEPLOY_STRATEGY="$MANUAL_STRATEGY"
              echo "ë°°í¬ ì „ëµ: $DEPLOY_STRATEGY (ìˆ˜ë™ ì„ íƒ)"
            else
              DEPLOY_STRATEGY="docker-recreate"
              echo "ë°°í¬ ì „ëµ: Docker ì¬ìƒì„± (ê°•ì œ ë°°í¬ ê¸°ë³¸ê°’)"
            fi
            echo "deploy_strategy=$DEPLOY_STRATEGY" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "force_deploy=true" >> $GITHUB_OUTPUT
            echo "sync_all_files=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # ìˆ˜ë™ ì „ëµì´ ì§€ì •ëœ ê²½ìš° (workflow_dispatchì—ì„œë§Œ ìœ íš¨)
          MANUAL_STRATEGY="${{ inputs.deploy_strategy }}"
          if [ -n "$MANUAL_STRATEGY" ] && [ "$MANUAL_STRATEGY" != "auto" ]; then
            echo "ğŸ“‹ ìˆ˜ë™ ë°°í¬ ì „ëµ: $MANUAL_STRATEGY"
            DEPLOY_STRATEGY="$MANUAL_STRATEGY"
            echo "ë°°í¬ ì „ëµ: $DEPLOY_STRATEGY (ìˆ˜ë™ ì„ íƒ)"
            echo "deploy_strategy=$DEPLOY_STRATEGY" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "force_deploy=false" >> $GITHUB_OUTPUT
            echo "sync_all_files=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # ìë™ ë³€ê²½ì‚¬í•­ ë¶„ì„ (ê¸°ì¡´ ë¡œì§)
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          echo "ë³€ê²½ëœ íŒŒì¼: $CHANGED_FILES"
          
          # ë³€ê²½ ìœ í˜• ë¶„ì„
          DOCKER_CHANGED=false
          SCRIPTS_CHANGED=false
          
          if echo "$CHANGED_FILES" | grep -q "^docker/"; then
            DOCKER_CHANGED=true
            echo "Docker ì„¤ì • ë³€ê²½ ê°ì§€"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^scripts/"; then
            SCRIPTS_CHANGED=true
            echo "ìŠ¤í¬ë¦½íŠ¸ ë³€ê²½ ê°ì§€"
          fi
          
          # ë°°í¬ ì „ëµ ê²°ì • (ìš°ì„ ìˆœìœ„ ê¸°ë°˜)
          if [ "$DOCKER_CHANGED" = true ]; then
            DEPLOY_STRATEGY="docker-recreate"
            echo "ë°°í¬ ì „ëµ: Docker ì¬ìƒì„± (ëª¨ë“  ë³€ê²½ì‚¬í•­ í¬í•¨)"
          elif [ "$SCRIPTS_CHANGED" = true ]; then
            DEPLOY_STRATEGY="scripts-only"
            echo "ë°°í¬ ì „ëµ: ìŠ¤í¬ë¦½íŠ¸ ë™ê¸°í™”ë§Œ"
          else
            DEPLOY_STRATEGY="none"
            echo "ë°°í¬ ì „ëµ: ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          fi
          
          # ì¶œë ¥ ì„¤ì •
          echo "deploy_strategy=$DEPLOY_STRATEGY" >> $GITHUB_OUTPUT
          echo "docker_changed=$DOCKER_CHANGED" >> $GITHUB_OUTPUT
          echo "scripts_changed=$SCRIPTS_CHANGED" >> $GITHUB_OUTPUT
          echo "has_changes=$([ "$DEPLOY_STRATEGY" != "none" ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "force_deploy=false" >> $GITHUB_OUTPUT
          echo "sync_all_files=false" >> $GITHUB_OUTPUT
      
      - name: Execute Sync All Files
        if: steps.changes.outputs.sync_all_files == 'true'
        run: |
          echo "ğŸ”„ ëª¨ë“  íŒŒì¼ ë™ê¸°í™” ì‹¤í–‰ ì¤‘..."
          echo "  - Docker ì„¤ì • ë™ê¸°í™”"
          echo "  - ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ ë™ê¸°í™”"
          ./scripts/file-sync.sh all
          
          # ë™ê¸°í™” í›„ ì„œë²„ ìƒíƒœì— ë”°ë¼ ì¬ì‹œì‘ ê²°ì •
          SERVER_STATUS=$(./scripts/server-control.sh status | grep "ì„œë²„ ìƒíƒœ:" | tail -1 || echo "unknown")
          echo "í˜„ì¬ ì„œë²„ ìƒíƒœ: $SERVER_STATUS"
          
          if echo "$SERVER_STATUS" | grep -q "ì‹¤í–‰ ì¤‘"; then
            echo "ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì´ë¯€ë¡œ ì¬ì‹œì‘ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤."
            ./scripts/server-control.sh restart
          else
            echo "ì„œë²„ê°€ ì¤‘ì§€ëœ ìƒíƒœì´ë¯€ë¡œ ì‹œì‘ë§Œ ìˆ˜í–‰í•©ë‹ˆë‹¤."
            ./scripts/server-control.sh start
          fi
        env:
          FORCE_DEPLOY: 'false'
      
      - name: Execute Deploy
        if: steps.changes.outputs.has_changes == 'true' && steps.changes.outputs.sync_all_files == 'false'
        run: |
          if [ "${{ steps.changes.outputs.force_deploy }}" = "true" ]; then
            echo "ğŸš¨ ê°•ì œ ë°°í¬ ì‹¤í–‰ ì¤‘..."
            ./scripts/deploy.sh --strategy=${{ steps.changes.outputs.deploy_strategy }} --force
          else
            echo "ğŸ“‹ ì¼ë°˜ ë°°í¬ ì‹¤í–‰ ì¤‘..."
            ./scripts/deploy.sh --strategy=${{ steps.changes.outputs.deploy_strategy }}
          fi
        env:
          FORCE_DEPLOY: ${{ inputs.force_deploy || 'false' }}
      
      - name: Skip Deploy
        if: steps.changes.outputs.has_changes == 'false'
        run: echo "ë³€ê²½ì‚¬í•­ì´ ì—†ì–´ ë°°í¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
      
      - name: Verify Deployment
        if: success() && steps.changes.outputs.has_changes == 'true'
        run: |
          echo "ë°°í¬ ê²€ì¦ ì¤‘..."
          sleep 10
          ./scripts/server-control.sh status
        continue-on-error: true
      
      - name: Deploy Summary
        if: always()
        run: |
          echo "=== ë°°í¬ ìš”ì•½ ==="
          echo "ë°°í¬ ì „ëµ: ${{ steps.changes.outputs.deploy_strategy }}"
          echo "ê°•ì œ ë°°í¬: ${{ steps.changes.outputs.force_deploy }}"
          echo "ëª¨ë“  íŒŒì¼ ë™ê¸°í™”: ${{ steps.changes.outputs.sync_all_files }}"
          echo "ë³€ê²½ì‚¬í•­ ìˆìŒ: ${{ steps.changes.outputs.has_changes }}"
          
          if [ "${{ steps.changes.outputs.sync_all_files }}" = "true" ]; then
            echo "âœ… ëª¨ë“  íŒŒì¼ ë™ê¸°í™” ì™„ë£Œ"
          elif [ "${{ steps.changes.outputs.has_changes }}" = "true" ]; then
            echo "âœ… ë°°í¬ ì™„ë£Œ: ${{ steps.changes.outputs.deploy_strategy }}"
          else
            echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ ì—†ìŒ - ë°°í¬ ê±´ë„ˆëœ€"
          fi
      
      - name: Archive Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: deploy-logs-${{ github.run_number }}
          path: ${{ env.MINECRAFT_HOME }}/deploy-logs/deploy-*.log
          retention-days: 7

  backup:
    name: Backup World Data
    runs-on: self-hosted
    needs: deploy
    if: success()
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Execute Backup
        run: ./scripts/backup.sh
        continue-on-error: true
      
      - name: Archive Backup Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backup-logs-${{ github.run_number }}
          path: ${{ env.MINECRAFT_HOME }}/deploy-logs/backup-*.log
          retention-days: 3