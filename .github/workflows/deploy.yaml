name: Minecraft Server Deploy

on:
  push:
    branches:
      - main
    paths:
      - 'scripts/**'
      - 'config/**'
      - 'docker/**'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'ê°•ì œ ë°°í¬ (ë³€ê²½ì‚¬í•­ ë¬´ì‹œ)'
        required: false
        type: boolean
        default: false

env:
  MINECRAFT_HOME: /home/minecraft

jobs:
  deploy:
    name: Deploy Minecraft Server
    runs-on: self-hosted
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Setup Environment
        run: |
          mkdir -p $MINECRAFT_HOME/deploy-logs
          chmod +x scripts/*.sh
      
      - name: Analyze Changes
        id: changes
        run: |
          # ê°•ì œ ë°°í¬ í™•ì¸
          if [ "${{ inputs.force_deploy }}" = "true" ]; then
            echo "ğŸš¨ ê°•ì œ ë°°í¬ ëª¨ë“œ: ë³€ê²½ì‚¬í•­ ë¶„ì„ì„ ê±´ë„ˆëœë‹ˆë‹¤."
            DEPLOY_STRATEGY="docker-recreate"
            echo "ë°°í¬ ì „ëµ: Docker ì¬ìƒì„± (ê°•ì œ ë°°í¬)"
            echo "deploy_strategy=$DEPLOY_STRATEGY" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "force_deploy=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          echo "ë³€ê²½ëœ íŒŒì¼: $CHANGED_FILES"
          
          # ë³€ê²½ ìœ í˜• ë¶„ì„
          CONFIG_CHANGED=false
          DOCKER_CHANGED=false
          SCRIPTS_CHANGED=false
          
          if echo "$CHANGED_FILES" | grep -q "^config/"; then
            CONFIG_CHANGED=true
            echo "ì„¤ì • íŒŒì¼ ë³€ê²½ ê°ì§€"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^docker/"; then
            DOCKER_CHANGED=true
            echo "Docker ì„¤ì • ë³€ê²½ ê°ì§€"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^scripts/"; then
            SCRIPTS_CHANGED=true
            echo "ìŠ¤í¬ë¦½íŠ¸ ë³€ê²½ ê°ì§€"
          fi
          
          # ë°°í¬ ì „ëµ ê²°ì • (ìš°ì„ ìˆœìœ„ ê¸°ë°˜)
          if [ "$DOCKER_CHANGED" = true ]; then
            DEPLOY_STRATEGY="docker-recreate"
            echo "ë°°í¬ ì „ëµ: Docker ì¬ìƒì„± (ëª¨ë“  ë³€ê²½ì‚¬í•­ í¬í•¨)"
          elif [ "$CONFIG_CHANGED" = true ] && [ "$SCRIPTS_CHANGED" = true ]; then
            DEPLOY_STRATEGY="config-scripts-restart"
            echo "ë°°í¬ ì „ëµ: ì„¤ì •+ìŠ¤í¬ë¦½íŠ¸ ì—…ë°ì´íŠ¸ + ì„œë²„ ì¬ì‹œì‘"
          elif [ "$CONFIG_CHANGED" = true ]; then
            DEPLOY_STRATEGY="config-restart"
            echo "ë°°í¬ ì „ëµ: ì„¤ì • ì—…ë°ì´íŠ¸ + ì„œë²„ ì¬ì‹œì‘"
          elif [ "$SCRIPTS_CHANGED" = true ]; then
            DEPLOY_STRATEGY="scripts-only"
            echo "ë°°í¬ ì „ëµ: ìŠ¤í¬ë¦½íŠ¸ ë™ê¸°í™”ë§Œ"
          else
            DEPLOY_STRATEGY="none"
            echo "ë°°í¬ ì „ëµ: ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          fi
          
          # ì¶œë ¥ ì„¤ì •
          echo "deploy_strategy=$DEPLOY_STRATEGY" >> $GITHUB_OUTPUT
          echo "config_changed=$CONFIG_CHANGED" >> $GITHUB_OUTPUT
          echo "docker_changed=$DOCKER_CHANGED" >> $GITHUB_OUTPUT
          echo "scripts_changed=$SCRIPTS_CHANGED" >> $GITHUB_OUTPUT
          echo "has_changes=$([ "$DEPLOY_STRATEGY" != "none" ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "force_deploy=false" >> $GITHUB_OUTPUT
      
      - name: Execute Deploy
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          if [ "${{ steps.changes.outputs.force_deploy }}" = "true" ]; then
            echo "ğŸš¨ ê°•ì œ ë°°í¬ ì‹¤í–‰ ì¤‘..."
            ./scripts/deploy.sh --strategy=${{ steps.changes.outputs.deploy_strategy }} --force
          else
            ./scripts/deploy.sh --strategy=${{ steps.changes.outputs.deploy_strategy }}
          fi
        env:
          FORCE_DEPLOY: ${{ inputs.force_deploy || 'false' }}
      
      - name: Skip Deploy
        if: steps.changes.outputs.has_changes == 'false'
        run: echo "ë³€ê²½ì‚¬í•­ì´ ì—†ì–´ ë°°í¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
      
      - name: Verify Deployment
        if: success()
        run: |
          sleep 10
          ./scripts/server-control.sh status
        continue-on-error: true
      
      - name: Archive Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: deploy-logs-${{ github.run_number }}
          path: ${{ env.MINECRAFT_HOME }}/deploy-logs/deploy-*.log
          retention-days: 7

  backup:
    name: Backup World Data
    runs-on: self-hosted
    needs: deploy
    if: success()
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Execute Backup
        run: ./scripts/backup.sh
        continue-on-error: true
      
      - name: Archive Backup Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backup-logs-${{ github.run_number }}
          path: ${{ env.MINECRAFT_HOME }}/deploy-logs/backup-*.log
          retention-days: 3